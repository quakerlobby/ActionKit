{% load actionkit_tags switchcase %}
{% filter remove_blank_lines %}

{% comment %}

  To change which fields show, edit {% hide_by_default %} below and set
  individual pages' required fields in the page admin, or activate the 
  User Fields customization option in the page admin to override which
  fields are visible and the order they're shown in.
  
  Unhide or require the 'country' field to make the form international. To
  geolocate more users outside the United States, unhide/require 'city'.
  
  You can change label text in the language admin, change {% field_order %}
  below, edit the CSS, or replace this form entirely with static HTML. See
  the advanced template ref for more:
  
  https://roboticdogs.actionkit.com/docs/manual/guide/advanced_templates.html

  name email prefix first_name middle_name last_name suffix country address1 address2 city state zip region postal phone
  
  Enjoy!

{% endcomment %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script src="//raw.githubusercontent.com/mailcheck/mailcheck/master/src/mailcheck.js"></script>
  <script type="text/javascript">
    var $email = $('#id_email');
    var $hint = $("#hint");

    $email.on('blur',function() {
      $hint.css('display', 'none').empty();
      $(this).mailcheck({
        suggested: function(element, suggestion) {
          if(!$hint.html()) {
            // First error - fill in/show entire hint element
            var suggestion = "Did you mean <span class='suggestion'>" +
                              "<span class='address'>" + suggestion.address + "</span>"
                              + "@<a href='#' class='domain'>" + suggestion.domain + 
                              "</a></span>?";
                              
            $hint.html(suggestion).fadeIn(150);
          } else {
            // Subsequent errors
            $(".address").html(suggestion.address);
            $(".domain").html(suggestion.domain);
          }
        }
      });
    });

    $hint.on('click', '.domain', function() {
      // On click, fill in the field with the suggestion and remove the hint
      $email.val($(".suggestion").text());
      $hint.fadeOut(200, function() {
        $(this).empty();
      });
      return false;
    });
  </script>


{% field_order name email prefix first_name middle_name last_name suffix country address1 address2 city state zip region postal phone %}
{% hide_by_default prefix first_name middle_name last_name suffix country phone address1 address2 city state region postal %}

{% for field in user_fields %}
    <div id="id_{{ field.field_name }}_box" class="{% if field.field_name|is_in:context.required %}required{% endif %}">
        <label for="id_{{ field.field_name }}">
            {{ field.label_text }}{% if field.field_name|is_in:context.required %}<span class="ak-required-flag">*</span>{% endif %}
        </label>
        {% switch field.field_name %}
            {% case 'country' %}
                {% include "./country_select.html" %}
            {% case 'state' %} 
                {% include "./state_select.html" %}
            {% else %}
                {{ field.input_html }}
        {% endswitch %}
    </div>
{% endfor %}

{% if 'country'|is_in:fields %}
    <input type="hidden" name="auto_country" value="1">
    <style type="text/css">
        /* Ensure that, if there's no JavaScript, the global-friendly 
         * fields show rather than the US-only ones */
        #id_zip_box, #id_state_box { display: none; }
    </style>
{% else %}
    <input type="hidden" name="country" value="United States">
{% endif %}

{% endfilter %}
